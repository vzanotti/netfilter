\section<presentation>[Principes et risques]{Les principes et les risques du filtrage}
  \begin{frame}
    \frametitle{Contexte: un filtre transparent}
    \begin{itemize}
      \item<1-> Filtrer du traffic (web) sans toucher aux connexions TCP.\\
        \only<1>{
          \begin{figure}[h]
            \includegraphics[width=0.8\textwidth]{pictures/filter-before.png}
          \end{figure}
        }
        \only<2->{
          \begin{figure}[h]
            \includegraphics[width=0.8\textwidth]{pictures/filter-after.png}
          \end{figure}
        }
      \item<3-> Cas d'école: appliquer des règles de QoS restrictives sur les fichiers {\tt .pdf}.
      \item<4-> Hypothèse: l'un des coté est neutre (pas de complicité).
    \end{itemize}
  \end{frame}

  \begin{frame}[t]
    \frametitle{Fonctionnement d'un filtre applicatif}
    Fonctionnement d'un filtre transparent au niveau 7 (OSI):
    \begin{itemize}
      \item<1-> Identification et groupage des packets par session TCP.\\
        \only<1>{\tt\scriptsize
          <tcp src=129.104.201.51 dst=87.98.164.72 sport=4242 dport=80> et \\
          <tcp src=87.98.164.72 dst=129.104.201.51 sport=80 dport=4242>
        }
      \item<2-> Extraction du contenu des buffers egress/ingress.\\
        \only<2>{\tt\scriptsize
          > GET /abcd.pdf HTTP/1.0\\
          > Host: www.blih.org\\
          > \\
          < HTTP/1.1 200 OK\\
          \dots
        }
      \item<3-> Détection du protocole utilisé.
      \item<4-> Extraction des information (protocol buffer).\\
        \only<4>{\tt\scriptsize
          proto=HTTP, method=GET, url=/abcd.pdf
        }
      \item<5-> Classification finale.\\
        \only<5>{
          Exemple de règle: {\tt\scriptsize proto=HTTP method=GET url=.*$\backslash$.pdf}
        }
    \end{itemize}
  \end{frame}

  \begin{frame}
    \frametitle{Attaques et contournement d'un filtre applicatif}
    \begin{itemize}
      \item Contournement via les couches 3/4 OSI.
        \begin{itemize}
          \item Fragmentation des paquets au niveau IP.
          \item Ré-arrangement des paquets TCP.
        \end{itemize}
      \item Contournement via l'implémentation du protocole
        \begin{itemize}
          \item Contournement par exploitation du protocole
          \item Contournement par non-respect du protocole
        \end{itemize}
      \item Attaque \emph{Denial of Service} classique
    \end{itemize}
  \end{frame}

  \begin{frame}
    \frametitle{Contournement par fragmentation des paquets}
    Idée: casser ``l'atomicité'' des échanges avec des petits paquets.
    \begin{itemize}
      \item<1-> Le protocole http est un protocole \emph{human readable}.
      \item<1-> Une requête http normale passe dans un paquet TCP.\\
        {\small C'est à dire que {\tt sizeof(requete + headers) <= max payload size}}
      \item<1-> Implémentation naïve: filtrage par paquets.
      \item<2-> Attaque:\\
        {\scriptsize
          Original: {\tt "GET /abcd.pdf HTTP/1.0"}\\
          Modifié:  {\tt "GE" "T /abcd.pdf HTT" "P/1.0"}
        }
      \item<3-> Défense: utilisation de buffers egress/ingress pour la session TCP.
    \end{itemize}
  \end{frame}

  \begin{frame}
    \frametitle{Contournement par \emph{reordering} des paquets TCP}
    Idée: réordonner les paquets TCP pour tromper le filtre.
    \begin{itemize}
      \item<1-> Support du réarrangement de paquets dans TCP.
      \item<1-> Normalement:\\
        {\tt\scriptsize
          > pkt=1, payload="GET /abcd.pdf HTTP/1.0"
        }
      \item<2-> Après fragmentation:\\
        {\tt\scriptsize
          > pkt=1, payload="GE"\\
          > pkt=2, payload="T /abcd.pdf HTT"\\
          > pkt=3, payload="P/1.0"
        }
      \item<3-> Après re-arrangement:\\
        {\tt\scriptsize
          > pkt=1, payload="GE"\\
          > pkt=3, payload="P/1.0"\\
          > pkt=2, payload="T /abcd.pdf HTT"
        }
      \item<4-> Défense: rearrangement manuel, complexe, coûteux.
    \end{itemize}
  \end{frame}

  \begin{frame}[t]
    \frametitle{Contournement par exploitation du protocole}
    Idée: exploiter des fonctionnalités obscures (ou pas) du protocole.
    \begin{itemize}
      \item<1-> Le protocole http a une fonctionnalité de sérialisation de requêtes.
      \item<2-> Fonctionnement du \emph{Keepalive}:\\
        \only<2->{\tt\scriptsize
          > \textcolor{red}{GET / HTTP/1.0}\\
          > ... {\sf\it en-têtes}\\
          > Connection: Keep-Alive\\
          > ... \\
          < HTTP/1.0 200 OK\\
          < ... \\
          > \textcolor{red}{GET /abcd.pdf HTTP/1.0}\\
          > ...
        }
      \item<3-> Défense: implémentation complète du protocole (long).
    \end{itemize}
  \end{frame}

  \begin{frame}[t]
    \frametitle{Contournement par non-respect du protocole}
    Idée: utiliser des \emph{flavor} peu connues ou des tolérances du protocole.
    \begin{itemize}
      \item<1-> En HTTP, la \emph{Response-Line} a la forme:\\
        {\tt\small HTTP/<version> <status-code> <reason-phrase>} \\
        {\scriptsize Par exemple: {\tt HTTP/1.1 404 Not Found}}
      \item<1-> Un détecteur pas trop naïf (l7-filter) utilise:\\
        {\tt\small "HTTP/(0$\backslash$.9|1$\backslash$.0|1$\backslash$.1) [1-5][0-9][0-9] "}
      \item<2-> Mais, dans une vieille version d'HTTP parlée par Apache:\\
        {\tt\scriptsize
          > GET /abcd.pdf\\
          < \textcolor{red}{\em content}
        }
      \item<3-> Défense: implémanter \emph{toutes} les versions du protocole (très fastidieux !)
    \end{itemize}
  \end{frame}

  \begin{frame}[t]
    \frametitle{Attaque \emph{Denial of Service} classique}
    Idée: exploiter les implémentations naïves du protocole.
    \begin{itemize}
      \item<1-> La plupart des procoles sont \emph{human readable}.
      \item<1-> D'où une utilisation des \emph{lignes} ($\backslash$r, $\backslash$n).
      \item<2-> D'où l'utilisation de buffer de ligne dans le filtre.
      \item<3-> Attaque: des lignes longues (> 64ko).
      \item<3-> Risques: buffer overflow (\emph{SIGSEGV} au mieux), memory exhaustion (\emph{oom-killer} sous linux).
      \item<4-> Défense: programmation très minutieuse, arrêt de la détection après quelques \emph{ko} échangés.
    \end{itemize}
  \end{frame}
